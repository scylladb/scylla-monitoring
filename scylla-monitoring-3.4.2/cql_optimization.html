


<!doctype html>
<html class="no-js" lang="en">
  
<head><!-- begin head.html -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>
    The CQL Optimiztion | Scylla Docs
    </title>
    <meta name="description" content="Scylla is an Apache Cassandra-compatible NoSQL data store that can handle 1 million transactions per second on a single server." />

    <link rel="icon" href="_static/img/favicon.ico" type="image/x-icon"/>
    <link rel="canonical" href="https://docs.scylladb.com/">

    <link rel="author" href="mailto:info@scylladb.com">
    <link rel="stylesheet" href="_static/" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    
    <link href='https://fonts.googleapis.com/css?family=Roboto:400,100,300,500,700' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/foundation/5.5.2/css/foundation.min.css" type="text/css" />
    <link rel="stylesheet" href="_static/css/doc/main.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />

    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/language_data.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/expertrec.js"></script>

    <script src="_static/js/vendor/modernizr.js"></script>
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
      new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-T8P2JP');</script>
    <!-- End Google Tag Manager -->

    <!-- Marketo -->
    <script type="text/javascript"> (function() { var didInit = false; function initMunchkin() { if(didInit === false) { didInit = true; Munchkin.init('791-QBF-350'); } } var s = document.createElement('script'); s.type = 'text/javascript'; s.async = true; s.src = '//munchkin.marketo.net/munchkin.js'; s.onreadystatechange = function() { if (this.readyState == 'complete' || this.readyState == 'loaded') { initMunchkin(); } }; s.onload = initMunchkin; document.getElementsByTagName('head')[0].appendChild(s); })(); </script>
    <!-- End Marketo -->

<!-- end head.html -->
</head>

<body>
<header id="header" class="animated">
    <div class="topbar_continer contain-to-grid clearfix">
        <nav class="top-bar" id="top-bar" data-topbar role="navigation">
            <ul class="title-area">
                <li class="name">
                    <div class="logo">
                        <a href="https://docs.scylladb.com/"><img src="_static/img/logo-scylla-docs.svg" alt="" width="151"></a>
                    </div>
                </li>
                <li class="toggle-topbar"><a href="#"><span class="icon-manu"></span></a></li>
            </ul>
            <section class="top-bar-section clearfix">
                <ul class="right">
                    
                    <li>
                        <a href="https://scylladb.github.io/scylla-monitoring/">Scylla Monitor</a>
                    </li>
                    
                    <li>
                        <a href="https://docs.scylladb.com/scylla-cloud/">Scylla Cloud</a>
                    </li>
                    
                    <li>
                        <a href="https://university.scylladb.com/">Scylla University</a>
                    </li>
                    
                    <li>
                        <a href="https://www.scylladb.com/">ScyllaDB Home</a>
                    </li>
                    
                    <li class="search_continer show-for-medium-up">	
                        <ci-search></ci-search>	
                    </li>	
                </ul>
            </section>
        </nav>
    </div>
</header>
<section id="content">
    <div class="row">
	
	<div class="large-6 large-push-3 columns">
            
                <p>
                    <strong>
                    
                    You're reading the documentation for a development version.
                    For the latest released version, please have a look at <a href="../master/cql_optimization.html">
		    	
				latest
		    	</a>.
                    
                    </strong>
                </p>
            

            <div class="section" id="the-cql-optimiztion">
<h1>The CQL Optimiztion<a class="headerlink" href="#the-cql-optimiztion" title="Permalink to this headline">¶</a></h1>
<p>The CQL Optimization is part of the CQL Dashboard and is a tool to help identify potentials issues with queries, data model and driver.</p>
<div class="figure align-default" id="id2">
<img alt="_images/cql_optimization_master.png" src="_images/cql_optimization_master.png" />
<p class="caption"><span class="caption-text"><strong>The CQL Dashboard</strong></span><a class="headerlink" href="#id2" title="Permalink to this image">¶</a></p>
</div>
<p>The upper part of the dashboard holds CQL related metrics.</p>
<p>The lower parts holds gauges and graphs. When inspecting the system, we like the gauge to be near zero and the graphs as low as possible.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Besides your queries, there are queries generated by the cql driver and internal queries to the system tables which can be misleading when testing with low traffic.</p>
</div>
<p>The following sections describe each of the dashboard’s panel</p>
<div class="section" id="prepared-statements">
<h2>Prepared Statements<a class="headerlink" href="#prepared-statements" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="/getting-started/definitions/#prepared-statements">Prepared statements</a> are queries that are first defined as a template with place holders for the values and then that template is used
multiple times with different values.</p>
<p>Using prepared statements has the following benefits:</p>
<ul class="simple">
<li><p>The database only needs to parse the query once</p></li>
<li><p>The driver can route the query to the right node</p></li>
<li><p>Using place-holders and values is safer and prevents CQL-Injection</p></li>
</ul>
<p>The <strong>CQL Non-Prepared Queries</strong> Gauge shows the percentage of queries that are not prepared.</p>
<p>The <strong>CQL Non-Prepared Queries</strong> Graph shows the rate of the queries. Make sure both are low.</p>
</div>
<div class="section" id="token-aware">
<h2>Token Aware<a class="headerlink" href="#token-aware" title="Permalink to this headline">¶</a></h2>
<p>Scylla is a distributed database, with each node contains only part of the data - a range of the token ring.
Ideally, a query would reach the node that holds the data (one of the replicas), failing to do so would mean the coordinator
will need to send the query internally to a replica, result with a higher latency,
and more resources usage.</p>
<p>Typically, your driver would know how to route the queries to a replication node, but using non-prepared statements, non-token-aware driver
or load-balance can cause the query to reach a node that is not a replica.</p>
<p>The <strong>Non-Token Aware</strong> Gauge shows the percentage of queries that reached a node that does not hold that data (a node that is not a replica-node).</p>
<p>The <strong>Non-Token Aware Queries</strong> Graph shows the rate of the queries that did not reach a replica-node, make sure both are low.</p>
</div>
<div class="section" id="paged-queries">
<h2>Paged Queries<a class="headerlink" href="#paged-queries" title="Permalink to this headline">¶</a></h2>
<p>By default, read queries are paged, this means that Scylla will break the results into multiple chunks limiting the reply size.
Non-Paged queries require all results be returned in one result increasing the overall load of the system and clients and should be avoided.</p>
<p>The <strong>Non-Paged CQL Reads</strong> Gauge shows the percentage of non-paged read queries that did not use paging.</p>
<p>The <strong>Non-Paged CQL Reads</strong> Graph shows the rate of the non-paged queries, make sure both are low.</p>
</div>
<div class="section" id="reversed-cql-reads">
<h2>Reversed CQL Reads<a class="headerlink" href="#reversed-cql-reads" title="Permalink to this headline">¶</a></h2>
<p>Scylla supports compound primary keys with a clustering column, this kind of primary keys allows an efficient way
to return sorted results that are sorted by the clustering column.</p>
<p>Querying with an order different than the order the <code class="docutils literal notranslate"><span class="pre">CLUSTERING</span> <span class="pre">ORDER</span> <span class="pre">BY</span></code> was defined is inefficient and should be avoided.</p>
<p>For example, look at the following table:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>CREATE TABLE ks1.table_demo <span class="o">(</span>
   category text,
   <span class="nb">type</span> int,
   PRIMARY KEY <span class="o">(</span>category, <span class="nb">type</span><span class="o">))</span>
WITH CLUSTERING ORDER BY <span class="o">(</span><span class="nb">type</span> DESC<span class="o">)</span><span class="p">;</span>
</pre></div>
</div>
<p>The following query uses reverse order:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="k">select</span> * from ks1.table_demo where <span class="nv">category</span><span class="o">=</span><span class="s1">&#39;cat1&#39;</span> order by <span class="nb">type</span> ASC<span class="p">;</span>
</pre></div>
</div>
<p>The <strong>Reversed CQL Reads</strong> Gauge shows the percentage of read queries that use <code class="docutils literal notranslate"><span class="pre">ORDER</span> <span class="pre">BY</span></code> that is different than the <code class="docutils literal notranslate"><span class="pre">CLUSTERING</span> <span class="pre">ORDER</span> <span class="pre">BY</span></code>.</p>
<p>The <strong>Reversed CQL Reads</strong> Graph shows the rate of the read queries that use <code class="docutils literal notranslate"><span class="pre">ORDER</span> <span class="pre">BY</span></code> that is different than the <code class="docutils literal notranslate"><span class="pre">CLUSTERING</span> <span class="pre">ORDER</span> <span class="pre">BY</span></code>, make sure both are low.</p>
</div>
<div class="section" id="allow-filtering">
<h2>ALLOW FILTERING<a class="headerlink" href="#allow-filtering" title="Permalink to this headline">¶</a></h2>
<p>Scylla supports server side data filtering that is not based on the primary key. This means Scylla would read data and then filter and
return part of it to the user. Data that is read and then filtered is an overhead to the system.</p>
<p>These kinds of queries can create a big load on the system, and should be used with care.</p>
<p>The CQL optimization dashboard, check for two things related to queries that use <code class="docutils literal notranslate"><span class="pre">ALLOW</span> <span class="pre">FILTERING</span></code> how many such queries exist and how much of the data that was read was
dropped before returning to the client.</p>
<p>The <strong>ALLOW FILTERING CQL Reads</strong> Gauge shows the percentage of read queries that use <code class="docutils literal notranslate"><span class="pre">ALLOW</span> <span class="pre">FILTERING</span></code>.</p>
<p>The <strong>ALLOW FILTERING CQL Reads</strong> Graph shows the rate of the read queries that use <code class="docutils literal notranslate"><span class="pre">ALLOW</span> <span class="pre">FILTERING</span></code>, make sure both are low.</p>
<p>The <strong>ALLOW FILTERING Filtered Rows</strong> Gauge shows the percentage of rows that were read and then filtered, this is an indication of the additional overhead to the system.</p>
<p>The <strong>ALLOW FILTERING Filtered Rows</strong> Graph shows multiple graphs: the rows that were read, the rows that matched and the rows that were dropped. Rows that
were dropped are an additional overhead to the system.</p>
</div>
<div class="section" id="consistency-level">
<h2>Consistency Level<a class="headerlink" href="#consistency-level" title="Permalink to this headline">¶</a></h2>
<p>Typically data in Scylla is duplicated into multiple replicas for availability reasons. A coordinator node would get the request and will send it
to the nodes holding the replicas.</p>
<p>A query Consistency Level determines at what point the coordinator will reply to the client with regards to the number of replied it got from the replicas.
The most common case is to use QUORUM, that means that when the coordinator gets a majority of the replies from the replicas it will return success to the client.</p>
<p>Two consistency levels hold a potential problem and should be used with care <code class="docutils literal notranslate"><span class="pre">ANY</span></code> and <code class="docutils literal notranslate"><span class="pre">ALL</span></code>.</p>
<p>The <strong>CQL ANY Queries</strong> Gauge shows the percentage of queries that use Consistency Level <code class="docutils literal notranslate"><span class="pre">ANY</span></code>. Using consistency level ANY in a query may hurt persistency, if the node receiving the request will fail, the data may be lost.</p>
<p>The <strong>CQL ANY CL Queries</strong> Graph shows the rate of the queries that use Consistency Level <code class="docutils literal notranslate"><span class="pre">ANY</span></code>, make sure both are low.</p>
<p>The <strong>CQL ALL CL Queries</strong> Gauge shows the percentage of queries that use Consistency Level <code class="docutils literal notranslate"><span class="pre">ALL</span></code>. Using consistency level ALL in a query may hurt availability, if a node is unavailable the operations will fail.</p>
<p>The <strong>CQL ALL CL Queries</strong> Graph shows the rate of the queries that use Consistency Level <code class="docutils literal notranslate"><span class="pre">ALL</span></code>, make sure both are low.</p>
</div>
</div>
<div class="section" id="cross-dc">
<h1>Cross DC<a class="headerlink" href="#cross-dc" title="Permalink to this headline">¶</a></h1>
<p>Cross DC traffic is usually more expensive in terms of latencies and cost.
This metric reports on such traffic in situations were it could be avoided.</p>
<div class="section" id="cross-dc-consistency-level">
<h2>Cross DC Consistency Level<a class="headerlink" href="#cross-dc-consistency-level" title="Permalink to this headline">¶</a></h2>
<p>Using consistency level QUORUM or consistency level ONE in a query when there is more than one DC may hurt performance,
as queries may end in the non-local DC. Use LOCAL_QUORUM and LOCAL_ONE instead.</p>
</div>
<div class="section" id="cross-dc-read-requests">
<h2>Cross DC read requests<a class="headerlink" href="#cross-dc-read-requests" title="Permalink to this headline">¶</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The CQL Optimization Dashboard relies on the definition of nodes per Data Center in the Monitoring Stack (prometheus/scylla_servers.yml) to match the Data Center names used in Scylla Cluster.
If this is not the case, you will see the wrong result.</p>
</div>
<p>In a typical situation, a client performs a read from the nearest data-center and that query is performed local to the data-center.
A read request that ends up causing traffic between data-centers adds additional overhead to the system.</p>
<p>The <strong>Cross DC read requests</strong> Gauge shows the percentage of read queries that caused a request to an external data-center, make sure it is low or zero.</p>
</div>
</div>

        </div>

        <div id="sidebar" class="large-3 large-pull-6 columns"><div class="side-nav">
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="matrix.html">Scylla Monitor Support Matrix</a></li>
<li class="toctree-l1"><a class="reference internal" href="monitoring_stack.html">Install Scylla Monitor Stack</a></li>
<li class="toctree-l1"><a class="reference internal" href="start_all.html">The start-all.sh script</a></li>
<li class="toctree-l1"><a class="reference internal" href="monitoring_apis.html">Scylla Monitor Interfaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="monitor_without_docker.html">Deploy Scylla Monitor Without Docker</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">The CQL Optimiztion</a></li>
<li class="toctree-l1"><a class="reference internal" href="#cross-dc">Cross DC</a></li>
<li class="toctree-l1"><a class="reference internal" href="updating_dashboard.html">Adding and Modifying Dashboards</a></li>
<li class="toctree-l1"><a class="reference internal" href="alerting.html">Alerting</a></li>
<li class="toctree-l1"><a class="reference internal" href="monitor_troubleshoot.html">Troubleshoot Monitor</a></li>
</ul>

</div>
        </div>

        <div class="large-3 columns">
            
                <div class="versions-dropdown">
    <button class="button"><span class="version">

	
		scylla-monitoring-3.4.2
	
	 <i class="fa fa-caret-down" aria-hidden="true"></i>
    </button>
    <ul class="content">
  	<li><a href="../master/cql_optimization.html">
		
			latest
		
	</a></li>
        <li><a href="cql_optimization.html">scylla-monitoring-3.4.2</a></li>
    </ul>
</div>
            
        </div>

    </div>
</section>

<!-- newsleter modal -->

<div id="newsletter_signup" class="reveal-modal tiny radius dark_modal" data-reveal aria-labelledby="modalTitle" aria-hidden="true" role="dialog">
    <a class="close-reveal-modal" aria-label="Close">×</a>
    <h2 id="modalTitle">Sign up for the Scylla newsletter</h2>
    <div id="mc_embed_signup">
        <form action="//cloudius-systems.us10.list-manage.com/subscribe/post?u=df8bb543c68230d5f7b4dcf78&amp;id=9a4589f144" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate="">
            <div id="mc_embed_signup_scroll">

                <div class="mc-field-group">
                    <div class="row collapse">
                        <div class="small-3 columns"><label for="mce-EMAIL">Email</label></div>
                        <div class="small-9 columns"><input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL"></div>
                    </div>
                </div>
                <div class="mc-field-group">
                    <div class="row collapse">
                        <div class="small-3 columns"><label for="mce-FNAME">First Name </label></div>
                        <div class="small-9 columns"><input type="text" value="" name="FNAME" class="" id="mce-FNAME"></div>
                    </div>
                </div>
                <div class="mc-field-group">
                    <div class="row collapse">
                        <div class="small-3 columns"><label for="mce-LNAME">Last Name </label></div>
                        <div class="small-9 columns"><input type="text" value="" name="LNAME" class="" id="mce-LNAME"></div>
                    </div>
                </div>
                <div id="mce-responses" class="clear">
                    <div class="response" id="mce-error-response" style="display:none"></div>
                    <div class="response" id="mce-success-response" style="display:none"></div>
                </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
                <div style="position: absolute; left: -5000px;"><input type="text" name="b_df8bb543c68230d5f7b4dcf78_9a4589f144" tabindex="-1" value=""></div>
                <div class="clear"><input type="submit" class="button" value="Sign up" name="subscribe" id="mc-embedded-subscribe"></div>
            </div>
        </form>
    </div>
</div>

<!-- end newsleter modal -->



<!-- footer.html -->
<footer id="footer">
    <div class="footer-top">
        <a class="logo" href="https://www.scylladb.com"><img src="_static/img/logo-scylla-horizontal-RGB.svg" alt=""></a>
        <div class="footer-links">
            <a class="link" href="https://docs.scylladb.com">Docs</a>
            <a class="link" href="https://www.scylladb.com/company/contact-us/">Contact Us</a>
            <a class="link" href="https://www.scylladb.com/company/">About Us</a>
            <a class="link button" href="https://github.com/scylladb/scylla-monitoring/issues/new?title=Issue in page The CQL Optimiztion&&body=I%20would%20like%20to%20report%20an%20issue%20in%20page%20http://docs.scylladb.com/cql_optimization%0A%0A%23%23%23%20Problem%0A%0A%23%23%23%20%20Suggest%20a%20fix" target="_blank">
                Report an issue on this page</a>
        </div>
        <div class="footer-actions">
            <a class="link-icon" href="https://github.com/ScyllaDB" target="_blank">
                <span class="icon-github2"></span></a>
            <a class="link-icon" href="https://twitter.com/ScyllaDB" target="_blank">
                <span class="icon-twitter"></span></a>
            <a class="link-icon" href="https://www.linkedin.com/company/scylladb"  target="_blank">
                <span class="icon-linkedin2"></span></a>
            <a class="link-icon" href="https://www.facebook.com/scylladb/" target="_blank">
                <span class="icon-facebook"></span></a>
        </div>
    </div>

    <div class="footer-bottom">
        <div class="footer-info">
            <div class="footer-copyright">
                &#169; 2020, ScyllaDB. All rights reserved.
            </div>
            <div class="footer-last-updated">
                Last updated on 28 July 2020.
            </div>
        </div>
        <div class="footer-links">
        </div>
    </div>
</footer>
<!-- end footer.html -->

<!-- bodyscripts.html -->
<!-- at the end of the BODY --> 
<script src="_static/js/vendor/jquery.js"></script>
<script src="_static/expertrec.js"></script>
<script src="_static/js/foundation/foundation.js"></script>
<script src="_static/js/foundation/foundation.topbar.js"></script>
<script src="_static/app.js"></script>
<script>
    $(document).foundation();
</script>
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-T8P2JP"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->

  <!-- end bodyscripts.html -->
</body>
</html>
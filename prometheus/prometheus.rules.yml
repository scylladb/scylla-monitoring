groups:
- name: scylla.rules
  rules:
  - alert: InstanceDown
    expr: up == 0
    for: 30s
    labels:
      severity: "2"
    annotations:
      description: '{{ $labels.instance }} has been down for more than 30 seconds.'
      summary: Instance {{ $labels.instance }} down
  - alert: DiskFull
    expr: node_filesystem_avail{mountpoint="/var/lib/scylla"} / node_filesystem_size{mountpoint="/var/lib/scylla"}
      * 100 < 25
    for: 30s
    labels:
      severity: "2"
    annotations:
      description: '{{ $labels.instance }} has less than 25% free disk space.'
      summary: Instance {{ $labels.instance }} low disk space
  - alert: DiskFull
    expr: node_filesystem_avail{mountpoint="/var/lib/scylla"} / node_filesystem_size{mountpoint="/var/lib/scylla"}
      * 100 < 10
    for: 30s
    labels:
      severity: "3"
    annotations:
      description: '{{ $labels.instance }} has less than 10% free disk space.'
      summary: Instance {{ $labels.instance }} low disk space
  - alert: DiskFull
    expr: node_filesystem_avail{mountpoint="/var/lib/scylla"} / node_filesystem_size{mountpoint="/var/lib/scylla"}
      * 100 < 1
    for: 30s
    labels:
      severity: "4"
    annotations:
      description: '{{ $labels.instance }} has less than 1% free disk space.'
      summary: Instance {{ $labels.instance }} low disk space
  - alert: CpuUtilized
    expr: max(scylla_reactor_utilization)by (instance) > 90
    for: 120s
    labels:
      severity: "2"
    annotations:
      description: '{{ $labels.instance }} has CPU utilization over 90% for more than 120s'
      summary: Instance {{ $labels.instance }} high CPU utilization
  - alert: CpuUtilized
    expr: max(scylla_reactor_utilization)by (instance) > 99
    for: 120s
    labels:
      severity: "3"
    annotations:
      description: '{{ $labels.instance }} has CPU utilization over 99% for more than 120s'
      summary: Instance {{ $labels.instance }} high CPU utilization
  - alert: ReadLatency
    expr: sum(rate(scylla_storage_proxy_coordinator_read_latency_sum[30s])) by (instance)/(sum(rate(scylla_storage_proxy_coordinator_read_latency_count[30s])) by (instance) +1)>500
    for: 60s
    labels:
      severity: "3"
    annotations:
      description: '{{ $labels.instance }} has average read latency over 500ms'
      summary: Instance {{ $labels.instance }} high read average latency
  - alert: Read95Latency
    expr: histogram_quantile(0.95, sum(rate(scylla_storage_proxy_coordinator_read_latency_bucket[5m])) by (le, instance))>500
    for: 60s
    labels:
      severity: "2"
    annotations:
      description: '{{ $labels.instance }} has 95th read latency over 500ms'
      summary: Instance {{ $labels.instance }} 95th read high latency
  - alert: InsertLatency
    expr: sum(rate(scylla_storage_proxy_coordinator_write_latency_sum[30s])) by (instance)/(sum(rate(scylla_storage_proxy_coordinator_write_latency_count[30s])) by (instance) +1)>500
    for: 60s
    labels:
      severity: "3"
    annotations:
      description: '{{ $labels.instance }} has average write latency over 500ms'
      summary: Instance {{ $labels.instance }} high average write latency
  - alert: Insert95Latency
    expr: histogram_quantile(0.95, sum(rate(scylla_storage_proxy_coordinator_write_latency_bucket[5m])) by (le, instance))>500
    for: 60s
    labels:
      severity: "2"
    annotations:
      description: '{{ $labels.instance }} has 95th write latency over 500ms'
      summary: Instance {{ $labels.instance }} 95th write high latency
  - alert: OpenConnections
    expr: node_sockstat_sockets_used>5000
    for: 60s
    labels:
      severity: "2"
    annotations:
      description: '{{ $labels.instance }} has over 5000 open connections'
      summary: Instance {{ $labels.instance }} has many open connections
  - alert: PendingCompactions
    expr: scylla_compaction_manager_compactions>100
    for: 60s
    labels:
      severity: "2"
    annotations:
      description: '{{ $labels.instance }} has more than 100 pending compactions'
      summary: Instance {{ $labels.instance }} has many pending compactions
  - alert: LowMemory
    expr: node_memory_MemFree_bytes<500000000
    for: 60s
    labels:
      severity: "2"
    annotations:
      description: '{{ $labels.instance }} has lower than 0.5 GB for the last 60s'
      summary: Instance {{ $labels.instance }} with low free memory
  - alert: HighCQLTransaction
    expr: sum(rate(scylla_transport_requests_served[60s])) by (instance)>1000000
    for: 60s
    labels:
      severity: "2"
    annotations:
      description: '{{ $labels.instance }} has more than 1 million CQL operations per seconds'
      summary: Instance {{ $labels.instance }} with high CQL transactions
